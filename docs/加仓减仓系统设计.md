# 加仓减仓系统设计文档

## 1. 新增指令定义

### Primary Action 指令
| 指令 | 含义 | Symbol | 使用场景 |
|------|------|--------|---------|
| BUY | 开多单 | 币种 | 看涨，开新多仓 |
| SELL | 开空单 | 币种 | 看跌，开新空仓 |
| HOLD | 观望 | NONE | 不开新仓 |
| CLOSE_ALL | 清仓 | ALL | 关闭所有持仓 |

### Position Reviews 指令
| 指令 | 含义 | 需要pos_id | 使用场景 |
|------|------|-----------|---------|
| KEEP | 继续持有 | 是 | 保持现有仓位不变 |
| CLOSE | 平仓 | 是 | 完全平掉该仓位 |
| REDUCE | 减仓 | 是 | 部分平仓，降低风险 |
| ADD_LONG | 加多仓 | 是 | 趋势确认，增加多单 |
| ADD_SHORT | 加空仓 | 是 | 趋势确认，增加空单 |
| ADJUST_SL | 调整止损 | 是 | 移动止损 |
| ADJUST_TP | 调整止盈 | 是 | 调整止盈目标 |

## 2. 持仓信息格式

```json
{
  "symbol": "SOL/USDT",
  "pos_id": "123456789",  // OKX持仓ID
  "inst_id": "SOL-USDT-SWAP",  // 合约ID
  "side": "long",  // long/short
  "size": 0.1,  // 持仓数量
  "entry_price": 198.74,  // 开仓价
  "unrealized_pnl": -0.02,  // 未实现盈亏
  "leverage": 10,  // 杠杆
  "stop_loss": 194.80,  // 止损价
  "take_profit": 208.80  // 止盈价
}
```

## 3. AI决策格式

```json
{
  "primary_action": {
    "symbol": "币种/NONE/ALL",
    "signal": "BUY/SELL/HOLD/CLOSE_ALL",
    "confidence": "HIGH/MEDIUM/LOW",
    "reason": "理由",
    "stop_loss": 价格,
    "take_profit": 价格,
    "amount": 数量
  },
  "position_reviews": [
    {
      "symbol": "SOL/USDT",
      "pos_id": "123456789",  // 必须提供持仓ID
      "action": "KEEP/CLOSE/REDUCE/ADD_LONG/ADD_SHORT/ADJUST_SL/ADJUST_TP",
      "confidence": "HIGH/MEDIUM/LOW",
      "reason": "理由",
      "amount": 0.05,  // REDUCE/ADD时需要
      "new_stop_loss": 价格,  // ADJUST_SL时需要
      "new_take_profit": 价格  // ADJUST_TP时需要
    }
  ],
  "think": "分析过程"
}
```

## 4. 加仓减仓规则

### 加仓条件（ADD_LONG/ADD_SHORT）
- ✅ 趋势进一步确认（多指标共振）
- ✅ 当前持仓盈利
- ✅ 账户风险可控
- ✅ 加仓数量不超过原仓位的50%

### 减仓条件（REDUCE）
- ✅ 趋势开始减弱
- ✅ 部分止盈（锁定利润）
- ✅ 风险增加但不至于全平
- ✅ 减仓数量建议30-50%

## 5. 执行逻辑

### REDUCE（减仓）
```python
# 获取持仓信息
position = get_position_by_pos_id(pos_id)
current_size = position['size']
reduce_amount = decision['amount']  // AI指定的减仓数量

# 执行减仓（部分平仓）
close_side = 'sell' if position['side'] == 'long' else 'buy'
create_order(
    symbol=symbol,
    side=close_side,
    amount=reduce_amount,
    params={'reduceOnly': True}
)
```

### ADD_LONG/ADD_SHORT（加仓）
```python
# 获取持仓信息
position = get_position_by_pos_id(pos_id)
add_amount = decision['amount']  // AI指定的加仓数量

# 执行加仓（与原仓位同方向）
add_side = 'buy' if action == 'ADD_LONG' else 'sell'
create_order(
    symbol=symbol,
    side=add_side,
    amount=add_amount
)
```

## 6. 显示格式

### 持仓信息显示
```
当前持仓列表:(1个)

- SOL/USDT LONG
  持仓ID: 123456789 | 数量: 0.1 | 持仓时长: 15分钟
  开仓价: $198.74 | 未实现盈亏: $-0.02
  清算价: $180.00 | 杠杆: 10x
  止损: $194.80 | 止盈: $208.80
```

### 持仓管理执行显示
```
处理 SOL/USDT (持仓ID: 123456789):
建议: REDUCE
📉 执行减仓: 0.05 (50%)
✅ 减仓成功
```

## 7. 安全机制

1. **持仓ID验证**：必须提供正确的pos_id
2. **数量限制**：
   - 减仓：不超过当前持仓
   - 加仓：不超过原仓位的50%
3. **方向一致性**：
   - ADD_LONG只能用于多单
   - ADD_SHORT只能用于空单
4. **风险控制**：
   - 加仓前检查账户余额
   - 加仓后总仓位不超过风险限制
